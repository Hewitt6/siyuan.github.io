<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>要闻简报 · Siyuan</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Playfair+Display:wght@500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #fff;
      --bg-accent: linear-gradient(180deg, rgba(255,182,193,.25), rgba(255,255,255,0));
      --panel: #ffffff;
      --muted: #6b7280;
      --text: #0f172a;
      --brand: #6b8cff;
      --brand-2: #ffbcd1; /* blush */
      --accent: #ff7aa2; /* rose */
      --ring: 0 0 0 3px rgba(255,122,162,.18);
      --line: #e5e7eb;
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0;
      font-family: Inter, ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, Apple Color Emoji, Segoe UI Emoji, Noto Color Emoji;
      color: var(--text);
      background: radial-gradient(900px 500px at 10% -10%, rgba(255,188,209,.25), transparent 40%),
                  radial-gradient(800px 400px at 90% 0%, rgba(107,140,255,.15), transparent 45%),
                  var(--bg);
    }
    a { color: var(--brand); text-decoration: none; }
    a:hover { text-decoration: underline; }

    .wrap { max-width: 1100px; margin: 56px auto; padding: 0 22px; }
  .header { display:flex; align-items:center; justify-content:space-between; gap:16px; margin-bottom:20px; }
    .title { display:flex; align-items:baseline; gap:12px; }
  .title h1 { margin:0; font-size:30px; letter-spacing:.2px; font-family: 'Playfair Display', serif; background: linear-gradient(90deg, #ea4c89, #f9a8d4 40%, #6b8cff 85%); -webkit-background-clip: text; background-clip: text; color: transparent; }

  .panel { background: #fff; border:1px solid var(--line); box-shadow: 0 10px 30px rgba(17,24,39,.06); border-radius:18px; overflow:hidden; }

  .controls { display:grid; grid-template-columns: 1fr auto; gap:12px; padding:18px; background: linear-gradient(180deg, rgba(255,255,255,1), rgba(255,255,255,.95)); border-bottom:1px solid var(--line); }
    .row { display:flex; gap:12px; flex-wrap:wrap; }
    .input { background:#fff; color:var(--text); border:1px solid var(--line); border-radius:12px; padding:12px 14px; outline:none; }
    .input:focus { box-shadow: var(--ring); border-color: #ffc1d5; }
    .input::placeholder { color:#9ca3af; }
    .btn { background: linear-gradient(180deg, #ffd5e3, #ffc1d5); color:#782141; border:1px solid #ffc1d5; padding:12px 16px; border-radius:14px; cursor:pointer; font-weight:600; letter-spacing:.2px; transition:.15s ease; display:inline-flex; align-items:center; gap:8px; }
    .btn:hover { transform: translateY(-1px); box-shadow: 0 10px 24px rgba(255,158,188,.25); }
    .btn.secondary { background: #ffffff; border-color: var(--line); color:#374151; }
    .btn.ghost { background: transparent; border-color: var(--line); color:#374151; }
    .btn.success { background: linear-gradient(180deg, #c7ffd8, #a7f3d0); border-color: #a7f3d0; color:#065f46; }
    .hint { color: var(--muted); font-size:12px; }

  .main { display:grid; grid-template-columns: 1fr; gap:16px; padding:18px; }
    .card { background: #fff; border: 1px solid var(--line); border-radius:16px; padding:16px; }
    .card h3 { margin:0 0 10px; font-size:14px; color:#6b7280; letter-spacing:.2px; }

    pre.output { white-space: pre-wrap; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; background: #fafafa; padding: 12px; border-radius: 12px; border: 1px solid var(--line); min-height: 260px; }
    details.block { border-top:1px dashed var(--line); margin-top:10px; padding-top:10px; }
    .history-list { display:grid; gap:10px; }
    .history-item { background: #fafafa; border: 1px solid var(--line); border-radius: 10px; padding: 10px; }
    .chip { display:inline-block; padding:2px 8px; font-size:11px; border-radius:999px; background: #ffe3ec; border: 1px solid #ffd1df; margin-right:6px; color:#7a2944; }
    .footer { color:var(--muted); font-size:12px; text-align:center; margin:18px 0; }

    /* Mobile adjustments */
    @media (max-width: 720px) {
      .wrap { margin: 28px auto; padding: 0 14px; }
      .title h1 { font-size: 24px; }
      .controls { grid-template-columns: 1fr; gap: 10px; padding: 14px; }
      .controls .row:last-child .btn { width: 100%; justify-content: center; }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="header">
      <div class="title">
        <h1>美国要闻简报</h1>
      </div>
    </div>

    <div class="panel">
      <div class="controls">
        <div class="row" style="flex:1">
          <input id="apiKey" class="input" type="password" placeholder="必填：DeepSeek API Key（仅本地使用，不上传）" style="min-width:260px" />
          <input id="proxyUrl" class="input" type="text" placeholder="可选：代理地址（如 https://api.allorigins.win/raw?url= 或 你的 Workers 代理）" style="min-width:300px" />
          <select id="hoursSelect" class="input" style="min-width:120px">
            <option value="3">近 3 小时</option>
            <option value="6">近 6 小时</option>
            <option value="12" selected>近 12 小时</option>
            <option value="24">近 24 小时</option>
          </select>
        </div>
        <div class="row">
          <button id="runBtn" class="btn">抓取并生成</button>
        </div>
      </div>

      <div class="main">
        <div class="card">
          <h3>原始数据快照（最近一次抓取）</h3>
          <div class="hint" id="fetchHint">尚未开始</div>
          <details class="block">
            <summary>WallstreetCN</summary>
            <div class="hint" id="wscnCount"></div>
            <pre id="wscnJson" class="output" style="min-height:120px"></pre>
          </details>
          <details class="block">
            <summary>金十</summary>
            <div class="hint" id="jin10Count"></div>
            <pre id="jin10Json" class="output" style="min-height:120px"></pre>
          </details>
        </div>

        <div class="card">
          <h3>生成结果</h3>
          <pre id="output" class="output"></pre>
          <div class="row" style="margin-top:8px; justify-content:flex-end">
            <button id="copyBtn" class="btn success">复制摘要</button>
            <button id="downloadBtn" class="btn secondary">下载 .txt</button>
          </div>

          <details class="block">
            <summary>临时历史（仅会话内）</summary>
            <div id="historyList" class="history-list"></div>
          </details>
        </div>
      </div>
    </div>

    
  </div>

  <script>
    // ==== Utilities ====
    const $ = (sel) => document.querySelector(sel);
    const el = {
      apiKey: $('#apiKey'), proxy: $('#proxyUrl'), hours: $('#hoursSelect'), run: $('#runBtn'), output: $('#output'), copy: $('#copyBtn'), dl: $('#downloadBtn'),
      history: $('#historyList'), fetchHint: $('#fetchHint'), wscnCount: $('#wscnCount'), wscnJson: $('#wscnJson'), jin10Count: $('#jin10Count'), jin10Json: $('#jin10Json')
    };

    function formatCN(d = new Date()) {
      return new Intl.DateTimeFormat('zh-CN', { timeZone: 'Asia/Shanghai', year:'numeric', month:'numeric', day:'numeric', hour:'2-digit', minute:'2-digit'}).format(d);
    }
    function headerTitle() {
      const d = new Date();
      const hour = new Intl.DateTimeFormat('zh-CN', { timeZone: 'Asia/Shanghai', hour: '2-digit', hour12: false }).formatToParts(d).find(p=>p.type==='hour')?.value || '00';
      const h = parseInt(hour, 10);
      const period = h < 11 ? '晨' : h < 18 ? '午' : '晚';
      const parts = new Intl.DateTimeFormat('zh-CN', { timeZone: 'Asia/Shanghai', year:'numeric', month:'numeric', day:'numeric' }).formatToParts(d);
      const y = parts.find(p=>p.type==='year').value;
      const m = parts.find(p=>p.type==='month').value;
      const day = parts.find(p=>p.type==='day').value;
      return `${y}年${m}月${day}日${period} 美国要闻简报`;
    }
  function formatYmdHMSInTZ(date, tz='Asia/Shanghai') {
      const parts = new Intl.DateTimeFormat('zh-CN', { timeZone: tz, year:'numeric', month:'2-digit', day:'2-digit', hour:'2-digit', minute:'2-digit', second:'2-digit', hour12:false }).formatToParts(date);
      const get = (t) => parts.find(p=>p.type===t)?.value.padStart(2,'0');
      return `${get('year')}-${get('month')}-${get('day')} ${get('hour')}:${get('minute')}:${get('second')}`;
    }
  function cutoffTS() { const hb = parseInt(el.hours?.value || '12', 10); return Date.now() - hb * 3600 * 1000; }
    function inShanghai(ms) { return ms; } // Date stores UTC internally; compare absolute ms

    // ==== Fetchers (mirror logging_news.py) ====
    function buildProxiedUrl(original) {
      const p = (el.proxy.value || '').trim();
      if (!p) return original;
      // If contains {url} placeholder, replace
      if (p.includes('{url}')) return p.replace('{url}', encodeURIComponent(original));
      // AllOrigins style
      if (p.includes('allorigins')) return p + (p.includes('?') ? '&' : '?') + 'url=' + encodeURIComponent(original) + '&cache=false';
      // thingproxy-style pass-through
      if (p.endsWith('/')) return p + original;
      // default: try as query
      return p + (p.includes('?') ? '&' : '?') + 'url=' + encodeURIComponent(original);
    }

    async function fetchWSCN(limit = 200) {
      const url = `https://api-prod.wallstreetcn.com/apiv1/content/lives?channel=global-channel&client=pc&limit=${limit}`;
      const finalUrl = buildProxiedUrl(url);
      const resp = await fetch(finalUrl, { method: 'GET' });
      if (!resp.ok) throw new Error('WSCN 返回异常: ' + resp.status);
      const j = await resp.json();
      const items = [];
      const cutoff = cutoffTS();
      for (const it of (j?.data?.items || [])) {
        const tRaw = it.display_time;
        let tMs;
        if (typeof tRaw === 'number') {
          // seconds -> ms
          tMs = tRaw * 1000;
        } else if (typeof tRaw === 'string') {
          const t = new Date(tRaw);
          tMs = t.getTime();
        } else {
          continue;
        }
        if (inShanghai(tMs) >= cutoff) {
          const content = (it.content_text || '').trim();
          if (content) items.push(content);
        }
      }
      return { raw: j, items };
    }

    // Parse Jin10 times like "YYYY-MM-DD HH:mm:ss" as Asia/Shanghai local
    function parseJin10Shanghai(ts) {
      if (!ts) return NaN;
      // If ISO-like, let Date parse it
      if (ts.includes('T') || ts.endsWith('Z')) {
        const n = new Date(ts).getTime();
        return isNaN(n) ? NaN : n;
      }
      const m = ts.match(/^(\d{4})-(\d{1,2})-(\d{1,2})[ T](\d{1,2}):(\d{1,2})(?::(\d{1,2}))?$/);
      if (!m) return NaN;
      const y = parseInt(m[1], 10);
      const mo = parseInt(m[2], 10) - 1;
      const d = parseInt(m[3], 10);
      const h = parseInt(m[4], 10);
      const mi = parseInt(m[5], 10);
      const s = parseInt(m[6] || '0', 10);
      // Convert Shanghai local to UTC ms (UTC = local - 8h)
      return Date.UTC(y, mo, d, h - 8, mi, s);
    }

    async function fetchJin10(num = 300) {
      const url = 'https://flash-api.jin10.com/get_flash_list';
      const params = new URLSearchParams({ channel: '-8200', num: String(num), max_time: formatYmdHMSInTZ(new Date(), 'Asia/Shanghai') });
      const original = `${url}?${params.toString()}`;
      const finalUrl = buildProxiedUrl(original);
      const useDirect = finalUrl === original;
      const init = useDirect
        ? { method: 'GET', headers: { 'x-app-id': 'SO1EJGmNgCtmpcPF', 'x-version': '1.0.0' } }
        : { method: 'GET' }; // proxies like AllOrigins won't forward our custom headers
      const resp = await fetch(finalUrl, init);
      if (!resp.ok) throw new Error('Jin10 返回异常: ' + resp.status);
      const j = await resp.json();
      const items = [];
      const cutoff = cutoffTS();
      for (const it of (j?.data || [])) {
        const tStr = it?.time || it?.created_time;
        if (!tStr) continue;
        const tMs = parseJin10Shanghai(String(tStr));
        if (!(tMs >= cutoff)) continue;
        const content = (it?.data && typeof it.data === 'object' ? it.data.content : (it?.data || {})).content || it?.title || '';
        if (content) items.push(String(content).trim());
      }
      return { raw: j, items };
    }

    async function deepseekSummarize(lines, apiKey) {
      const system_msg = '你是一名财经媒体编辑。请阅读用户给出的原始快讯条目，筛选 & 精炼成一份【美国要闻简报】。\n输出要求：\n1. 顶部保留我给出的日期标题。\n2. 你自行拟 3-6 个小标题（如“美国政治动态”“金融市场”），保证涵盖：政治、政策、经济、科技（AI/量子/生物医药等前沿）、金融五大领域。\n3. 每个小标题下列出若干要点；每条 ≤40 字；信息准确、无重复。\n4. 所有内容用简体中文，不要markdown格式，要适合微信发消息的格式，标题前写上序号，每一条前用一个bullet point。\n5. 严禁编造新闻，仅用提供的信息。';
      const user_msg = headerTitle() + '\n' + lines.map(b => `- ${b}`).join('\n');
      const body = { model: 'deepseek-chat', messages: [ { role: 'system', content: system_msg }, { role: 'user', content: user_msg } ] };
      const resp = await fetch('https://api.deepseek.com/chat/completions', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` },
        body: JSON.stringify(body)
      });
      if (!resp.ok) throw new Error('DeepSeek API 调用失败：' + resp.status);
      const j = await resp.json();
      return j?.choices?.[0]?.message?.content || '';
    }

    // ==== UI state ====
    const sessionHistory = []; // {time, output}
    let lastSnapshots = { wscn: null, jin10: null }; // raw json

    function setLoading(loading) {
      el.run.disabled = loading;
      el.run.textContent = loading ? '处理中…' : '抓取并生成';
    }
    function renderHistory() {
      el.history.innerHTML = '';
      sessionHistory.slice().reverse().forEach(item => {
        const div = document.createElement('div');
        div.className = 'history-item';
        const meta = document.createElement('div');
        meta.className = 'hint';
        meta.innerHTML = `<span class="chip">DeepSeek</span> ${item.time}`;
        const pre = document.createElement('pre');
        pre.className = 'output';
        pre.textContent = item.output;
        div.appendChild(meta); div.appendChild(pre);
        el.history.appendChild(div);
      });
    }
    function updateSnapshotsUI(wscn, jin10) {
      const wCount = (wscn?.items || []).length; const jCount = (jin10?.items || []).length;
      el.fetchHint.textContent = `抓取完成 · WSCN: ${wCount} 条 · 金十: ${jCount} 条 · 时间：${formatCN()}`;
      el.wscnCount.textContent = `条目数：${wCount}`;
      el.jin10Count.textContent = `条目数：${jCount}`;
      el.wscnJson.textContent = JSON.stringify(wscn?.raw || {}, null, 2);
      el.jin10Json.textContent = JSON.stringify(jin10?.raw || {}, null, 2);
    }

    async function run() {
      const apiKey = el.apiKey.value.trim();
      if (!apiKey) { alert('请先填写 DeepSeek API Key'); return; }
      setLoading(true);
      const hoursStr = `${parseInt(el.hours?.value || '12', 10)} 小时`;
      el.fetchHint.textContent = `开始 · 时间窗：${hoursStr}`;
      try {
        let wscn = { raw: null, items: [] };
        let jin10 = { raw: null, items: [] };
        // fetch both; tolerate failures like Python main()
        try { el.fetchHint.textContent = '抓取 WSCN 中…'; wscn = await fetchWSCN(); el.fetchHint.textContent = `WSCN 抓取完成（${wscn.items.length}）· 继续抓取金十…`; } catch(e) { console.warn('[ERR] WSCN', e); el.fetchHint.textContent = 'WSCN 抓取失败，继续抓取金十…'; }
        try { jin10 = await fetchJin10(); } catch(e) { console.warn('[ERR] Jin10', e); }
        lastSnapshots = { wscn, jin10 };
        updateSnapshotsUI(wscn, jin10);

        const all = [...(wscn.items||[]), ...(jin10.items||[])];
        el.fetchHint.textContent = `${el.fetchHint.textContent} · 调用 DeepSeek 生成中…`;
        const out = await deepseekSummarize(all, apiKey);
        el.output.textContent = out;
        sessionHistory.push({ time: formatCN(), output: out });
        renderHistory();
        el.fetchHint.textContent = `${el.fetchHint.textContent.replace(/ · 调用 DeepSeek 生成中…$/, '')} · 生成完成 ✓`;
      } catch (e) {
        console.error(e);
        alert('执行失败：' + e.message + '\n若为跨域 (CORS) 限制，请改用自建后端或代理。');
      } finally {
        setLoading(false);
      }
    }

    function copyOutput() {
      const txt = el.output.textContent || '';
      if (!txt.trim()) return;
      navigator.clipboard.writeText(txt).then(() => {
        el.copy.textContent = '已复制 ✓';
        setTimeout(()=> el.copy.textContent = '复制摘要', 1200);
      });
    }
    function downloadOutput() {
      const txt = el.output.textContent || '';
      if (!txt.trim()) return;
      const blob = new Blob([txt], { type: 'text/plain;charset=utf-8' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = `要闻简报_${Date.now()}.txt`;
      a.click(); URL.revokeObjectURL(url);
    }

    el.run.addEventListener('click', run);
    el.copy.addEventListener('click', copyOutput);
    el.dl.addEventListener('click', downloadOutput);
  </script>
</body>
</html>
