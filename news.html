<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>要闻简报 · Siyuan</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Playfair+Display:wght@500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #fff;
      --bg-accent: linear-gradient(180deg, rgba(255,182,193,.25), rgba(255,255,255,0));
      --panel: #ffffff;
      --muted: #6b7280;
      --text: #0f172a;
      --brand: #6b8cff;
      --brand-2: #ffbcd1; /* blush */
      --accent: #ff7aa2; /* rose */
      --ring: 0 0 0 3px rgba(255,122,162,.18);
      --line: #e5e7eb;
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0;
      font-family: Inter, ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, Apple Color Emoji, Segoe UI Emoji, Noto Color Emoji;
      color: var(--text);
      background: radial-gradient(900px 500px at 10% -10%, rgba(255,188,209,.25), transparent 40%),
                  radial-gradient(800px 400px at 90% 0%, rgba(107,140,255,.15), transparent 45%),
                  var(--bg);
    }
    a { color: var(--brand); text-decoration: none; }
    a:hover { text-decoration: underline; }

    .wrap { max-width: 1100px; margin: 56px auto; padding: 0 22px; }
  .header { display:flex; align-items:center; justify-content:space-between; gap:16px; margin-bottom:20px; }
    .title { display:flex; align-items:baseline; gap:12px; }
  .title h1 { margin:0; font-size:30px; letter-spacing:.2px; font-family: 'Playfair Display', serif; background: linear-gradient(90deg, #ea4c89, #f9a8d4 40%, #6b8cff 85%); -webkit-background-clip: text; background-clip: text; color: transparent; }

  .panel { background: #fff; border:1px solid var(--line); box-shadow: 0 10px 30px rgba(17,24,39,.06); border-radius:18px; overflow:hidden; }

  .controls { display:grid; grid-template-columns: 1fr auto; gap:12px; padding:18px; background: linear-gradient(180deg, rgba(255,255,255,1), rgba(255,255,255,.95)); border-bottom:1px solid var(--line); }
    .row { display:flex; gap:12px; flex-wrap:wrap; }
    .input { background:#fff; color:var(--text); border:1px solid var(--line); border-radius:12px; padding:12px 14px; outline:none; }
    .input:focus { box-shadow: var(--ring); border-color: #ffc1d5; }
    .input::placeholder { color:#9ca3af; }
    .btn { background: linear-gradient(180deg, #ffd5e3, #ffc1d5); color:#782141; border:1px solid #ffc1d5; padding:12px 16px; border-radius:14px; cursor:pointer; font-weight:600; letter-spacing:.2px; transition:.15s ease; display:inline-flex; align-items:center; gap:8px; }
    .btn:hover { transform: translateY(-1px); box-shadow: 0 10px 24px rgba(255,158,188,.25); }
    .btn.secondary { background: #ffffff; border-color: var(--line); color:#374151; }
    .btn.ghost { background: transparent; border-color: var(--line); color:#374151; }
    .btn.success { background: linear-gradient(180deg, #c7ffd8, #a7f3d0); border-color: #a7f3d0; color:#065f46; }
    .hint { color: var(--muted); font-size:12px; }

  .main { display:grid; grid-template-columns: 1fr; gap:16px; padding:18px; }
    .card { background: #fff; border: 1px solid var(--line); border-radius:16px; padding:16px; }
    .card h3 { margin:0 0 10px; font-size:14px; color:#6b7280; letter-spacing:.2px; }

    pre.output { white-space: pre-wrap; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; background: #fafafa; padding: 12px; border-radius: 12px; border: 1px solid var(--line); min-height: 260px; }
    details.block { border-top:1px dashed var(--line); margin-top:10px; padding-top:10px; }
    .history-list { display:grid; gap:10px; }
    .history-item { background: #fafafa; border: 1px solid var(--line); border-radius: 10px; padding: 10px; }
    .chip { display:inline-block; padding:2px 8px; font-size:11px; border-radius:999px; background: #ffe3ec; border: 1px solid #ffd1df; margin-right:6px; color:#7a2944; }
    .footer { color:var(--muted); font-size:12px; text-align:center; margin:18px 0; }
  .tok { padding:0 2px; border-radius:4px; }
  .tok[data-risk="high"] { background:linear-gradient(145deg,#ff5f5f,#ff9b9b); color:#111; }
  .tok[data-risk="mid"] { background:linear-gradient(145deg,#ffd37a,#ffe7b0); color:#111; }
  /* ok 不加背景，保持原始视觉 */
  .tok[data-risk="ok"] { background:transparent; }
  .tok-tooltip { position:fixed; z-index:9999; background:rgba(17,24,39,.92); backdrop-filter:blur(8px); color:#f8fafc; font-size:12px; line-height:1.45; padding:10px 12px 12px; border-radius:14px; box-shadow:0 12px 32px -4px rgba(0,0,0,.35),0 0 0 1px rgba(255,255,255,.06); max-width:300px; pointer-events:none; opacity:0; transform:translateY(-6px) scale(.98); transition:.16s cubic-bezier(.4,.2,.2,1); border:1px solid rgba(255,255,255,.08); }
  .tok-tooltip.visible { opacity:1; transform:translateY(0) scale(1); }
  .tok-tooltip h4 { margin:0 0 6px; font-size:12px; font-weight:600; letter-spacing:.5px; text-transform:uppercase; display:flex; align-items:center; gap:6px; }
  .tok-tooltip .badge { display:inline-block; padding:2px 6px; border-radius:6px; font-size:10px; font-weight:600; letter-spacing:.5px; }
  .tok-tooltip .badge.high { background:#ff7171; color:#3b0b0b; }
  .tok-tooltip .badge.mid { background:#ffd37a; color:#4a3000; }
  .tok-tooltip .alts { display:grid; gap:4px; margin-top:4px; }
  .tok-tooltip .alt-item { background:rgba(255,255,255,.06); padding:4px 6px; border-radius:6px; display:flex; justify-content:space-between; font-family:ui-monospace,monospace; }
  .risk-legend { margin:10px 0 4px; display:flex; gap:10px; flex-wrap:wrap; font-size:11px; color:#6b7280; }
  .risk-legend span { display:inline-flex; align-items:center; gap:4px; }
  .risk-dot { width:14px; height:14px; border-radius:6px; display:inline-block; }
  .risk-dot.dot-high { background:linear-gradient(145deg,#ff5f5f,#ff9b9b); }
  .risk-dot.dot-mid { background:linear-gradient(145deg,#ffd37a,#ffe7b0); }
  .risk-dot.dot-ok { background:#eef2ff; border:1px solid #c7d2fe; }
  .tok-tooltip.visible { opacity:1; transform:translateY(0); }
  /* Mobile overlay */
  .tok-mobile-backdrop { position:fixed; inset:0; background:rgba(15,23,42,.52); backdrop-filter:blur(6px); -webkit-backdrop-filter:blur(6px); z-index:9998; animation:fadeIn .18s ease; }
  .tok-mobile-panel { position:fixed; left:50%; top:50%; transform:translate(-50%,-50%) scale(.96); width: min(440px,90vw); max-height:70vh; overflow:auto; background:linear-gradient(145deg,#1f2937,#111827); color:#f1f5f9; border:1px solid rgba(255,255,255,.08); border-radius:18px; padding:18px 18px 20px; box-shadow:0 18px 42px -8px rgba(0,0,0,.45), 0 0 0 1px rgba(255,255,255,.05); z-index:9999; opacity:0; animation:panelIn .22s cubic-bezier(.4,.2,.2,1) forwards; }
  .tok-mobile-panel h4 { margin:0 0 10px; font-size:13px; letter-spacing:.5px; display:flex; align-items:center; gap:8px; }
  .tok-mobile-panel .badge { padding:3px 8px; border-radius:8px; font-size:11px; font-weight:600; }
  .tok-mobile-panel .badge.high { background:#ff7171; color:#3b0b0b; }
  .tok-mobile-panel .badge.mid { background:#ffd37a; color:#4a3000; }
  .tok-mobile-panel .meta { font-size:11px; opacity:.82; line-height:1.5; }
  .tok-mobile-panel .alts { margin-top:10px; display:grid; gap:6px; }
  .tok-mobile-panel .alt-item { background:rgba(255,255,255,.07); padding:6px 8px; border-radius:8px; display:flex; justify-content:space-between; font-family:ui-monospace,monospace; font-size:12px; }
  .tok-mobile-close { position:absolute; top:8px; right:10px; background:rgba(255,255,255,.08); border:none; color:#f1f5f9; padding:4px 8px; border-radius:8px; font-size:12px; cursor:pointer; }
  @keyframes fadeIn { from { opacity:0 } to { opacity:1 } }
  @keyframes panelIn { to { opacity:1; transform:translate(-50%,-50%) scale(1);} }

    /* Mobile adjustments */
    @media (max-width: 720px) {
      .wrap { margin: 28px auto; padding: 0 14px; }
      .title h1 { font-size: 24px; }
      .controls { grid-template-columns: 1fr; gap: 10px; padding: 14px; }
      .controls .row:last-child .btn { width: 100%; justify-content: center; }
    }

    #heartCanvas { position: fixed; top: 10px; right: 10px; pointer-events: none; z-index: 1000; }
  </style>
</head>
<body>
  <canvas id="heartCanvas" width="200" height="200"></canvas>
  <div class="wrap">
    <div class="header">
      <div class="title">
        <h1>美国要闻简报</h1>
      </div>
    </div>

    <div class="panel">
      <div class="controls">
        <div class="row" style="flex:1">
          <input id="apiKey" class="input" type="password" placeholder="必填：DeepSeek API Key（仅本地使用，不上传）" style="min-width:260px" />
          <input id="proxyUrl" class="input" type="text" placeholder="可选：代理地址（如 https://api.allorigins.win/raw?url= 或 你的 Workers 代理）" style="min-width:300px" />
          <select id="hoursSelect" class="input" style="min-width:120px">
            <option value="3">近 3 小时</option>
            <option value="6">近 6 小时</option>
            <option value="12" selected>近 12 小时</option>
            <option value="24">近 24 小时</option>
          </select>
        </div>
        <div class="row">
          <button id="runBtn" class="btn">抓取并生成</button>
        </div>
      </div>

      <div class="main">
        <div class="card">
          <h3>原始数据快照（最近一次抓取）</h3>
          <div class="hint" id="fetchHint">尚未开始</div>
          <details class="block">
            <summary>WallstreetCN</summary>
            <div class="hint" id="wscnCount"></div>
            <pre id="wscnJson" class="output" style="min-height:120px"></pre>
          </details>
          <details class="block">
            <summary>金十</summary>
            <div class="hint" id="jin10Count"></div>
            <pre id="jin10Json" class="output" style="min-height:120px"></pre>
          </details>
        </div>

        <div class="card">
          <h3>生成结果</h3>
          <div class="risk-legend" id="riskLegend" style="display:none; margin-top:0;">
            <span style="font-weight:600; color:#374151;">置信标注说明：</span>
            <span><i class="risk-dot dot-high"></i>高风险 (CCP < 0.15)</span>
            <span><i class="risk-dot dot-mid"></i>存疑 (0.15 ≤ CCP < 0.30)</span>
            <span><i class="risk-dot dot-ok"></i>可信 (≥ 0.30)</span>
          </div>
          <pre id="output" class="output"></pre>
          <div class="row" style="margin-top:8px; justify-content:flex-end">
            <button id="copyBtn" class="btn success">复制摘要</button>
            <button id="downloadBtn" class="btn secondary">下载 .txt</button>
          </div>

          <details class="block">
            <summary>临时历史（仅会话内）</summary>
            <div id="historyList" class="history-list"></div>
          </details>
        </div>
      </div>
    </div>

    
  </div>

  <script>
    // ==== Utilities ====
    const $ = (sel) => document.querySelector(sel);
    const el = {
      apiKey: $('#apiKey'), proxy: $('#proxyUrl'), hours: $('#hoursSelect'), run: $('#runBtn'), output: $('#output'), copy: $('#copyBtn'), dl: $('#downloadBtn'),
      history: $('#historyList'), fetchHint: $('#fetchHint'), wscnCount: $('#wscnCount'), wscnJson: $('#wscnJson'), jin10Count: $('#jin10Count'), jin10Json: $('#jin10Json')
    };

    function formatCN(d = new Date()) {
      return new Intl.DateTimeFormat('zh-CN', { timeZone: 'Asia/Shanghai', year:'numeric', month:'numeric', day:'numeric', hour:'2-digit', minute:'2-digit'}).format(d);
    }
    function headerTitle() {
      const d = new Date();
      const hour = new Intl.DateTimeFormat('zh-CN', { timeZone: 'Asia/Shanghai', hour: '2-digit', hour12: false }).formatToParts(d).find(p=>p.type==='hour')?.value || '00';
      const h = parseInt(hour, 10);
      const period = h < 11 ? '晨' : h < 18 ? '午' : '晚';
      const parts = new Intl.DateTimeFormat('zh-CN', { timeZone: 'Asia/Shanghai', year:'numeric', month:'numeric', day:'numeric' }).formatToParts(d);
      const y = parts.find(p=>p.type==='year').value;
      const m = parts.find(p=>p.type==='month').value;
      const day = parts.find(p=>p.type==='day').value;
      return `${y}年${m}月${day}日${period} 美国要闻简报`;
    }
  function formatYmdHMSInTZ(date, tz='Asia/Shanghai') {
      const parts = new Intl.DateTimeFormat('zh-CN', { timeZone: tz, year:'numeric', month:'2-digit', day:'2-digit', hour:'2-digit', minute:'2-digit', second:'2-digit', hour12:false }).formatToParts(date);
      const get = (t) => parts.find(p=>p.type===t)?.value.padStart(2,'0');
      return `${get('year')}-${get('month')}-${get('day')} ${get('hour')}:${get('minute')}:${get('second')}`;
    }
  function cutoffTS() { const hb = parseInt(el.hours?.value || '12', 10); return Date.now() - hb * 3600 * 1000; }
    function inShanghai(ms) { return ms; } // Date stores UTC internally; compare absolute ms

    // ==== Fetchers (mirror logging_news.py) ====
    function buildProxiedUrl(original) {
      const p = (el.proxy.value || '').trim();
      if (!p) return original;
      // If contains {url} placeholder, replace
      if (p.includes('{url}')) return p.replace('{url}', encodeURIComponent(original));
      // AllOrigins style
      if (p.includes('allorigins')) return p + (p.includes('?') ? '&' : '?') + 'url=' + encodeURIComponent(original) + '&cache=false';
      // thingproxy-style pass-through
      if (p.endsWith('/')) return p + original;
      // default: try as query
      return p + (p.includes('?') ? '&' : '?') + 'url=' + encodeURIComponent(original);
    }

    async function fetchWSCN(limit = 200) {
      const url = `https://api-prod.wallstreetcn.com/apiv1/content/lives?channel=global-channel&client=pc&limit=${limit}`;
      const finalUrl = buildProxiedUrl(url);
      const resp = await fetch(finalUrl, { method: 'GET' });
      if (!resp.ok) throw new Error('WSCN 返回异常: ' + resp.status);
      const j = await resp.json();
      const items = [];
      const cutoff = cutoffTS();
      for (const it of (j?.data?.items || [])) {
        const tRaw = it.display_time;
        let tMs;
        if (typeof tRaw === 'number') {
          // seconds -> ms
          tMs = tRaw * 1000;
        } else if (typeof tRaw === 'string') {
          const t = new Date(tRaw);
          tMs = t.getTime();
        } else {
          continue;
        }
        if (inShanghai(tMs) >= cutoff) {
          const content = (it.content_text || '').trim();
          if (content) items.push(content);
        }
      }
      return { raw: j, items };
    }

    // ===== Jin10 新方案：直接抓取 https://www.jin10.com/ 页面并用 DOM 提取 =====
    // 注意：若未配置可用的代理（支持绕过 CORS 并返回完整 HTML），直接在浏览器请求可能拿不到内容（opaque/no-cors）。
    // 用户可在“代理地址”里填写自己的反向代理，例如： https://api.allorigins.win/raw?url=
    function extractJin10FromDocument(doc) {
      const newsItems = [];
      const flashContainers = doc.querySelectorAll('#jin_flash_list .jin-flash-item-container');
      flashContainers.forEach(container => {
        const item = {};
        const timeElement = container.querySelector('.item-time');
        item.time = timeElement ? timeElement.textContent.trim() : '';
        const flashItem = container.querySelector('.jin-flash-item');
        if (!flashItem) return;
        item.isImportant = flashItem.classList.contains('is-important');
        item.isRili = flashItem.classList.contains('rili');
        item.isArticle = flashItem.classList.contains('article');
        item.isVip = flashItem.classList.contains('is-vip');
        if (item.isRili) {
          const titleElement = container.querySelector('.mid-title');
          const dataElements = container.querySelectorAll('.num-item span');
            item.title = titleElement ? titleElement.textContent.trim() : '数据发布';
            item.data = {
              previous: dataElements[0] ? dataElements[0].textContent.trim() : '',
              expected: dataElements[1] ? dataElements[1].textContent.trim() : '',
              actual: dataElements[2] ? dataElements[2].textContent.trim() : ''
            };
            item.content = `${item.title} - 前值: ${item.data.previous}, 预期: ${item.data.expected}, 公布: ${item.data.actual}`;
        } else if (item.isVip) {
          const flashTextElement = container.querySelector('.flash-text');
          item.content = flashTextElement ? flashTextElement.textContent.trim() : 'VIP内容，需要解锁';
          item.title = item.content;
        } else {
          const flashTextElement = container.querySelector('.flash-text');
          if (flashTextElement) {
            item.content = flashTextElement.innerHTML.trim();
            item.title = flashTextElement.textContent.trim();
          }
          if (item.isArticle) {
            const articleTitleElement = container.querySelector('.right-content_title span:last-child');
            if (articleTitleElement) item.title = articleTitleElement.textContent.trim();
          }
        }
        item.relevance = container.getAttribute('data-relevance') || '';
        item.link = null;
        const detailBtn = container.querySelector('.detail-btn a');
        if (detailBtn) item.link = detailBtn.href; else if (item.isArticle) {
          const articleLink = container.querySelector('.flash-item-share a[target="_blank"]');
          if (articleLink) item.link = articleLink.href;
        }
        if (item.content) newsItems.push(item);
      });
      return newsItems;
    }

    async function fetchJin10Scrape() {
      const pageUrl = 'https://www.jin10.com/';
      const finalUrl = buildProxiedUrl(pageUrl);
      let html;
      try {
        const resp = await fetch(finalUrl, { method: 'GET' });
        if (!resp.ok) throw new Error('Jin10 页面获取失败: ' + resp.status);
        html = await resp.text();
      } catch (e) {
        // 如果用户未配置 proxy，自动尝试 AllOrigins 作为兜底
        if (!(el.proxy.value || '').trim()) {
          el.fetchHint.textContent = '直接抓取金十失败，尝试公共代理…';
          try {
            const fallback = 'https://api.allorigins.win/raw?url=' + encodeURIComponent(pageUrl) + '&cache=false';
            const r2 = await fetch(fallback);
            if (!r2.ok) throw new Error('AllOrigins 失败: ' + r2.status);
            html = await r2.text();
          } catch (inner) {
            throw new Error('金十抓取失败（可能被 CORS 限制）。请在“代理地址”输入你的 Cloudflare Workers / 反向代理，例如 https://your-worker.workers.dev/?url= 或 https://api.allorigins.win/raw?url=' );
          }
        } else {
          throw e;
        }
      }
      const parser = new DOMParser();
      const doc = parser.parseFromString(html, 'text/html');
      const extracted = extractJin10FromDocument(doc);
  // 提供前 20 条样本，便于在 UI 里查看解析是否正确
  return { raw: { count: extracted.length, sample: extracted.slice(0,20) }, items: extracted };
    }

    async function deepseekSummarize(items, apiKey) {
      // items: [{content, isImportant}]
      const system_msg = '你是一名财经媒体编辑。请阅读用户给出的原始快讯条目（含是否标记为重要），筛选 & 精炼成一份【美国要闻简报】。\n输出要求：\n1. 顶部保留我给出的日期标题。\n2. 你自行拟 3-6 个小标题（如“美国政治动态”“金融市场”），保证涵盖：政治、政策、经济、科技（AI/量子/生物医药等前沿）、金融五大领域。\n3. 尽量优先利用被标记为重要的条目。\n4. 每个小标题下列出若干要点；每条 ≤40 字；信息准确、无重复。\n5. 所有内容用简体中文，不要markdown格式，要适合微信发消息的格式，标题前写上序号，每一条前用一个bullet point。\n6. 严禁编造新闻，仅用提供的信息。';
      const user_msg = headerTitle() + '\n' + items.map(obj => {
        const tag = obj.isImportant ? '[重要]' : '';
        return `- ${tag}${obj.content.replace(/\n+/g,' ').trim()}`;
      }).join('\n');
      const body = { model: 'deepseek-chat', logprobs: true, top_logprobs: 20, messages: [ { role: 'system', content: system_msg }, { role: 'user', content: user_msg } ] };
      const resp = await fetch('https://api.deepseek.com/chat/completions', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` },
        body: JSON.stringify(body)
      });
      if (!resp.ok) throw new Error('DeepSeek API 调用失败：' + resp.status);
      const j = await resp.json();
      const ch = j.choices?.[0];
      return { text: ch?.message?.content || '', tokens: ch?.logprobs?.content || [] };
    }

    // ========= CCP utils =========
    const THRESH_HI = 0.15, THRESH_LO = 0.30; // CCP 阈值（示例: <0.15 高风险; <0.30 存疑）

    function sameType(a, b) {
      const numA = /^\d+$/.test(a), numB = /^\d+$/.test(b);
      if (numA && numB) return true;
      const norm = (s) => s.replace(/^ /,'').toLowerCase().replace(/[^\w]/g,'');
      return norm(a) === norm(b);
    }
    function isEquiv(a, b) { return a.trim() === b.trim(); }
    function ccpOne(tokObj) {
      const pMain = Math.exp(tokObj.logprob || 0);
      let numer = 0, denom = 0;
      (tokObj.top_logprobs || []).forEach(item => {
        const p = Math.exp(item.logprob || 0);
        if (sameType(item.token, tokObj.token)) {
          denom += p;
          if (isEquiv(item.token, tokObj.token)) numer += p;
        }
      });
      if (!denom) denom = pMain || 1e-12;
      return numer / denom;
    }
    function tokensToHTML(tokens, plainFallback) {
      if (!Array.isArray(tokens) || !tokens.length) return (plainFallback || '').replace(/[&<>"']/g, c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[c]));
      const esc = (s='')=> s.replace(/[&<>"']/g, c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[c]));
      return tokens.map(t => {
        const tokenText = t.token ?? '';
        const ccp = ccpOne(t);
        const alts = (t.top_logprobs || [])
          .filter(x => x.token !== t.token)
          .sort((a,b) => (b.logprob||0) - (a.logprob||0));
        const a1 = alts[0]?.token || '';
        const a2 = alts[1]?.token || '';
        const a1p = alts[0] ? Math.exp(alts[0].logprob||0) : 0;
        const a2p = alts[1] ? Math.exp(alts[1].logprob||0) : 0;
        let risk = 'ok';
        if (ccp < THRESH_HI) risk = 'high'; else if (ccp < THRESH_LO) risk = 'mid';
        if (risk === 'ok') return esc(tokenText); // 不包装，保持原始连续文本
        const title = risk === 'high'
          ? `高风险 | CCP=${ccp.toFixed(3)}`
          : `存疑 | CCP=${ccp.toFixed(3)}`;
        return `<span class="tok" data-risk="${risk}" data-alt1="${esc(a1)}" data-alt2="${esc(a2)}" data-alt1p="${a1p.toFixed(4)}" data-alt2p="${a2p.toFixed(4)}" data-ccp="${ccp.toFixed(3)}" title="${esc(title)}">${esc(tokenText)}</span>`;
      }).join('');
    }
    // Tooltip logic (desktop hover, mobile tap)
    let _tokTooltipEl = null; let _activeTok = null;
    function ensureTokTooltip() {
      if (!_tokTooltipEl) {
        _tokTooltipEl = document.createElement('div');
        _tokTooltipEl.className = 'tok-tooltip';
        document.body.appendChild(_tokTooltipEl);
      }
      return _tokTooltipEl;
    }
    function hideTokTooltip() {
      if (_tokTooltipEl) { _tokTooltipEl.classList.remove('visible'); _tokTooltipEl.style.left='-9999px'; }
      _activeTok = null;
    }
    function showTokTooltip(node) {
      if (!node) return;
      const risk = node.dataset.risk;
      const alt1 = node.dataset.alt1;
      const alt2 = node.dataset.alt2;
      const alt1p = parseFloat(node.dataset.alt1p || '0');
      const alt2p = parseFloat(node.dataset.alt2p || '0');
      const ccp = node.dataset.ccp;
      const elTip = ensureTokTooltip();
      let label = risk === 'high' ? '高风险' : risk === 'mid' ? '存疑' : '可信';
      let badgeClass = risk === 'high' ? 'high' : risk === 'mid' ? 'mid' : 'ok';
      const fmtPct = (p)=> p ? (p*100).toFixed(1)+'%' : '';
      const altRows = [];
      if (alt1) altRows.push(`<div class="alt-item"><span>${alt1}</span><span>${fmtPct(alt1p)}</span></div>`);
      if (alt2) altRows.push(`<div class="alt-item"><span>${alt2}</span><span>${fmtPct(alt2p)}</span></div>`);
      elTip.innerHTML = `
        <h4>${label}<span class="badge ${badgeClass}">CCP ${ccp}</span></h4>
        <div style="font-size:11px;opacity:.85">CCP 越低表示该 token 在相同类型候选中被模型选择的置信度越低。</div>
        ${altRows.length?`<div class="alts">${altRows.join('')}</div>`:'<div style="margin-top:6px;opacity:.6;font-size:11px">无高概率替代候选</div>'}
      `;
      const isTouch = matchMedia('(hover: none)').matches || 'ontouchstart' in window;
      if (isTouch) {
        // 使用中央浮层方式
        if (document.querySelector('.tok-mobile-backdrop')) {
          document.querySelector('.tok-mobile-backdrop').remove();
        }
        const backdrop = document.createElement('div');
        backdrop.className = 'tok-mobile-backdrop';
        const panel = document.createElement('div');
        panel.className = 'tok-mobile-panel';
        const altRows = [];
        if (alt1) altRows.push(`<div class="alt-item"><span>${alt1}</span><span>${(alt1p*100).toFixed(1)}%</span></div>`);
        if (alt2) altRows.push(`<div class="alt-item"><span>${alt2}</span><span>${(alt2p*100).toFixed(1)}%</span></div>`);
        panel.innerHTML = `
          <button class="tok-mobile-close" aria-label="关闭">关闭</button>
          <h4>${label}<span class="badge ${badgeClass}">CCP ${ccp}</span></h4>
          <div class="meta">CCP 越低表示该 token 在同类候选中被模型选中的相对置信度越低。</div>
          ${altRows.length ? `<div class="alts">${altRows.join('')}</div>` : '<div style="margin-top:8px;opacity:.6;font-size:11px">无高概率替代候选</div>'}
        `;
        backdrop.appendChild(panel);
        document.body.appendChild(backdrop);
        const close = () => { backdrop.remove(); _activeTok = null; };
        backdrop.addEventListener('click', e => { if (e.target === backdrop) close(); });
        panel.querySelector('.tok-mobile-close').addEventListener('click', close);
        _activeTok = node;
        return;
      }
      // 桌面仍用 tooltip 模式
      const rect = node.getBoundingClientRect();
      elTip.style.visibility = 'hidden';
      elTip.style.display = 'block';
      elTip.classList.remove('visible');
      const scrollY = window.scrollY; const scrollX = window.scrollX;
      const vw = window.innerWidth; const vh = window.innerHeight;
      const tipW = elTip.offsetWidth; const tipH = elTip.offsetHeight;
      let top = rect.top + scrollY - tipH - 10;
      if (top < scrollY + 4) top = rect.bottom + scrollY + 10;
      if (top + tipH > scrollY + vh - 4) top = scrollY + vh - tipH - 10;
      let left = rect.left + scrollX + (rect.width - tipW)/2;
      if (left < scrollX + 4) left = scrollX + 4;
      const maxLeft = scrollX + vw - tipW - 4;
      if (left > maxLeft) left = maxLeft;
      elTip.style.top = top + 'px';
      elTip.style.left = left + 'px';
      elTip.style.visibility = 'visible';
      requestAnimationFrame(()=> { elTip.classList.add('visible'); });
      _activeTok = node;
    }
    function initTokenTooltips() {
      hideTokTooltip();
      const isTouch = matchMedia('(hover: none)').matches || 'ontouchstart' in window;
      document.querySelectorAll('.tok').forEach(tok => {
        tok.removeEventListener('mouseenter', tok._enterHandler || (()=>{}));
        tok.removeEventListener('mouseleave', tok._leaveHandler || (()=>{}));
        tok.removeEventListener('click', tok._clickHandler || (()=>{}));
        if (isTouch) {
          tok._clickHandler = (e) => {
            e.stopPropagation();
            if (_activeTok === tok) { hideTokTooltip(); return; }
            showTokTooltip(tok);
          };
          tok.addEventListener('click', tok._clickHandler);
        } else {
          tok._enterHandler = () => showTokTooltip(tok);
          tok._leaveHandler = () => { if (_activeTok === tok) hideTokTooltip(); };
          tok.addEventListener('mouseenter', tok._enterHandler);
          tok.addEventListener('mouseleave', tok._leaveHandler);
        }
      });
      if (!window._tokOutsideClickBound) {
        window._tokOutsideClickBound = true;
        document.addEventListener('click', () => hideTokTooltip());
        window.addEventListener('scroll', () => hideTokTooltip(), { passive:true });
      }
    }
  // colorizeCCP 已不再需要，样式由 CSS 控制，仅高/中风险有背景

    // ==== UI state ====
    const sessionHistory = []; // {time, output}
    let lastSnapshots = { wscn: null, jin10: null }; // raw json

    function setLoading(loading) {
      el.run.disabled = loading;
      el.run.textContent = loading ? '处理中…' : '抓取并生成';
    }
    function renderHistory() {
      el.history.innerHTML = '';
      sessionHistory.slice().reverse().forEach(item => {
        const div = document.createElement('div');
        div.className = 'history-item';
        const meta = document.createElement('div');
        meta.className = 'hint';
        meta.innerHTML = `<span class="chip">DeepSeek</span> ${item.time}`;
        const pre = document.createElement('pre');
        pre.className = 'output';
        pre.textContent = item.output;
        div.appendChild(meta); div.appendChild(pre);
        el.history.appendChild(div);
      });
    }
    function updateSnapshotsUI(wscn, jin10) {
      const wCount = (wscn?.items || []).length; const jCount = (jin10?.items || []).length;
      el.fetchHint.textContent = `抓取完成 · WSCN: ${wCount} 条 · 金十: ${jCount} 条 · 时间：${formatCN()}`;
      el.wscnCount.textContent = `条目数：${wCount}`;
      el.jin10Count.textContent = `条目数：${jCount}`;
      el.wscnJson.textContent = JSON.stringify(wscn?.raw || {}, null, 2);
      el.jin10Json.textContent = JSON.stringify(jin10?.raw || {}, null, 2);
    }

    async function run() {
      const apiKey = el.apiKey.value.trim();
      if (!apiKey) { alert('请先填写 DeepSeek API Key'); return; }
      setLoading(true);
      const hoursStr = `${parseInt(el.hours?.value || '12', 10)} 小时`;
      el.fetchHint.textContent = `开始 · 时间窗：${hoursStr}`;
      try {
        let wscn = { raw: null, items: [] };
        let jin10 = { raw: null, items: [] };
        // fetch both; tolerate failures like Python main()
        try { el.fetchHint.textContent = '抓取 WSCN 中…'; wscn = await fetchWSCN(); el.fetchHint.textContent = `WSCN 抓取完成（${wscn.items.length}）· 继续抓取金十…`; } catch(e) { console.warn('[ERR] WSCN', e); el.fetchHint.textContent = 'WSCN 抓取失败，继续抓取金十…'; }
    try { jin10 = await fetchJin10Scrape(); } catch(e) { console.warn('[ERR] Jin10', e); }
        lastSnapshots = { wscn, jin10 };
        updateSnapshotsUI(wscn, jin10);

    // 将 WSCN 字符串包装为统一结构
    const wscnObjs = (wscn.items || []).map(c => ({ content: c, isImportant: false }));
    const jin10List = (jin10.items || []); // 已经是对象
    // 重要优先 & 限制非重要最多 100 条
    const imp = jin10List.filter(i => i.isImportant);
    const nonImp = jin10List.filter(i => !i.isImportant).slice(0, 100);
    const combined = [...imp, ...nonImp, ...wscnObjs];
    el.fetchHint.textContent = `${el.fetchHint.textContent} · 调用 DeepSeek 生成中…`;
  const out = await deepseekSummarize(combined, apiKey);
  // Render token-level CCP coloring
  el.output.innerHTML = tokensToHTML(out.tokens, out.text);
  // 确保 legend 在内容前可见
  const legend = document.getElementById('riskLegend');
  if (legend) legend.style.display = 'flex';
  initTokenTooltips();
  sessionHistory.push({ time: formatCN(), output: out.text });
        renderHistory();
        el.fetchHint.textContent = `${el.fetchHint.textContent.replace(/ · 调用 DeepSeek 生成中…$/, '')} · 生成完成 ✓`;
      } catch (e) {
        console.error(e);
        alert('执行失败：' + e.message + '\n若为跨域 (CORS) 限制，请改用自建后端或代理。');
      } finally {
        setLoading(false);
      }
    }

    function copyOutput() {
      // For copy we need plain text (not token markup); reconstruct by joining tokens or fallback to textContent
      let txt = '';
      if (el.output.querySelector('.tok')) {
        txt = Array.from(el.output.querySelectorAll('.tok')).map(n => n.textContent || '').join('');
      } else {
        txt = el.output.textContent || '';
      }
      if (!txt.trim()) return;
      navigator.clipboard.writeText(txt).then(() => {
        el.copy.textContent = '已复制 ✓';
        setTimeout(()=> el.copy.textContent = '复制摘要', 1200);
      });
    }
    function downloadOutput() {
      let txt = '';
      if (el.output.querySelector('.tok')) {
        txt = Array.from(el.output.querySelectorAll('.tok')).map(n => n.textContent || '').join('');
      } else {
        txt = el.output.textContent || '';
      }
      if (!txt.trim()) return;
      const blob = new Blob([txt], { type: 'text/plain;charset=utf-8' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = `要闻简报_${Date.now()}.txt`;
      a.click(); URL.revokeObjectURL(url);
    }

    el.run.addEventListener('click', run);
    el.copy.addEventListener('click', copyOutput);
    el.dl.addEventListener('click', downloadOutput);

    // Heart particle animation
    const canvas = document.getElementById('heartCanvas');
    const ctx = canvas.getContext('2d');
    const particles = [];
    const numParticles = 100;
    let state = 'scatter'; // 'scatter' or 'gather'
    let stateTimer = 0;
    const stateDuration = 3000; // 3 seconds per state

    // Heart shape function
    function heartX(t) { return 16 * Math.pow(Math.sin(t), 3) * 3; }
    function heartY(t) { return (13 * Math.cos(t) - 5 * Math.cos(2 * t) - 2 * Math.cos(3 * t) - Math.cos(4 * t)) * 3; }

    // Initialize particles
    for (let i = 0; i < numParticles; i++) {
      particles.push({
        x: Math.random() * canvas.width,
        y: Math.random() * canvas.height,
        targetX: Math.random() * canvas.width,
        targetY: Math.random() * canvas.height,
        vx: 0,
        vy: 0
      });
    }

    function updateTargets() {
      if (state === 'gather') {
        // Assign targets to heart shape
        for (let i = 0; i < numParticles; i++) {
          const t = (i / numParticles) * 2 * Math.PI;
          particles[i].targetX = canvas.width / 2 + heartX(t);
          particles[i].targetY = canvas.height / 2 - heartY(t);
        }
      } else {
        // Scatter targets
        for (let i = 0; i < numParticles; i++) {
          particles[i].targetX = Math.random() * canvas.width;
          particles[i].targetY = Math.random() * canvas.height;
        }
      }
    }

    function animate() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);

      // Update state
      stateTimer += 16; // ~60fps
      if (stateTimer > stateDuration) {
        state = state === 'scatter' ? 'gather' : 'scatter';
        stateTimer = 0;
        updateTargets();
      }

      // Update particles
      particles.forEach(p => {
        const dx = p.targetX - p.x;
        const dy = p.targetY - p.y;
        const dist = Math.sqrt(dx * dx + dy * dy);
        if (dist > 1) {
          p.vx += dx * 0.01;
          p.vy += dy * 0.01;
          p.vx *= 0.95; // damping
          p.vy *= 0.95;
          p.x += p.vx;
          p.y += p.vy;
        }
        // Draw
        ctx.fillStyle = 'rgba(255, 122, 162, 0.8)'; // rose color
        ctx.beginPath();
        ctx.arc(p.x, p.y, 2, 0, Math.PI * 2);
        ctx.fill();
      });

      requestAnimationFrame(animate);
    }

    updateTargets();
    animate();
  </script>
</body>
</html>
